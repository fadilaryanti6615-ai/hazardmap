<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Peta PGA Kulon Progo</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; }
    #header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 70px;
      background: #003366;
      color: white;
      display: flex;
      align-items: center;
      padding: 0 15px;
      font-family: 'Open Sans', sans-serif;
      z-index: 3;
    }
    #header img { height: 50px; margin-right: 15px; }
    #header h1 { font-size: 20px; margin: 0; }
    .legend {
      position: absolute;
      bottom: 30px;
      left: 10px;
      background: white;
      padding: 10px;
      font-family: Arial;
      font-size: 12px;
      border-radius: 6px;
      box-shadow: 0 0 4px rgba(0,0,0,0.3);
      max-height: 90%;
      overflow-y: auto;
    }
    .legend h4 { margin: 4px 0; text-align: center; }
    .color-box { display: inline-block; width: 20px; height: 10px; margin-right: 5px; }
    .checkbox-group { margin-bottom: 6px; padding-left: 10px; }
  </style>
</head>
<body>

<div id="header">
  <img src="logo_ugm.png" alt="Logo UGM">
  <h1>Peta Potensi Goncangan di Kulon Progo Berdasarkan Nilai PGA</h1>
</div>

<div id="map"></div>

<div class="legend" id="legend">
  <h4>Legenda Peta</h4>
  <div><input type="checkbox" id="batasKP"> Batas Administrasi Kulon Progo</div>
  <div><input type="checkbox" id="fasum"> Fasilitas Umum</div>
  <div><input type="checkbox" id="sesaropak"> Garis Sesar Opak</div>
  <div><input type="checkbox" id="sesarsermo"> Garis Sesar Sermo</div>

  <hr>
  <strong>Sumber Gempa Bumi</strong><br>
  <div><input type="checkbox" id="sermo-toggle"> Sesar Sermo</div>
  <div class="checkbox-group" id="sermo-options" style="display:none;">
    <strong>Perulangan:</strong><br>
    <div><input type="checkbox" class="sermo-period" data-period="50"> 50 Tahun</div>
    <div><input type="checkbox" class="sermo-period" data-period="100"> 100 Tahun</div>
    <div id="sermo-prob" style="display:none;">
      <strong>Probabilitas:</strong><br>
      <div><input type="checkbox" class="sermo-prob" data-prob="01"> 0.1</div>
      <div><input type="checkbox" class="sermo-prob" data-prob="02"> 0.2</div>
      <div><input type="checkbox" class="sermo-prob" data-prob="05"> 0.5</div>
    </div>
  </div>

  <div><input type="checkbox" id="opak-toggle"> Sesar Opak</div>
  <div class="checkbox-group" id="opak-options" style="display:none;">
    <strong>Perulangan:</strong><br>
    <div><input type="checkbox" class="opak-period" data-period="50"> 50 Tahun</div>
    <div><input type="checkbox" class="opak-period" data-period="100"> 100 Tahun</div>
    <div id="opak-prob" style="display:none;">
      <strong>Probabilitas:</strong><br>
      <div><input type="checkbox" class="opak-prob" data-prob="01"> 0.1</div>
      <div><input type="checkbox" class="opak-prob" data-prob="02"> 0.2</div>
      <div><input type="checkbox" class="opak-prob" data-prob="05"> 0.5</div>
    </div>
  </div>

  <hr>
  <strong>Tingkat Bahaya Gempa Bumi Berdasarkan Nilai PGA</strong><br>
  <div><span class="color-box" style="background:yellow"></span>Rendah (0–0.26)</div>
  <div><span class="color-box" style="background:orange"></span>Sedang (0.26–0.7)</div>
  <div><span class="color-box" style="background:red"></span>Tinggi (>0.7)</div>
</div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoibmFkaWFzYWZhYXVyb3JhIiwiYSI6ImNseDJ3NGEwbzBybXgyaW9pdXpiNzhoNjEifQ.App12NjY_vjxookVmPAtLg';

// Gambar fasum
const fasumImages = {
  "Waduk Sermo": "waduksermo.jpg",
  "Bandara YIA": "bandara.jpg",
  "Jembatan Pandansimo": "JembatanPandansimo.jpg"
};

const map = new mapboxgl.Map({
  container: 'map',
  style: 'mapbox://styles/mapbox/light-v11',
  center: [110.16, -7.8],
  zoom: 9.8
});

const baseURL = 'https://raw.githubusercontent.com/nadiaaurora/hazard-map/main/';
const sources = {
  batasKP: baseURL + 'KulonProgo.geojson',
  fasum: baseURL + 'Fasum.geojson',
  sesarOpak: baseURL + 'SesarOpak.geojson',
  sesarSermo: baseURL + 'SesarSermo.geojson',
  sermo: {
    '50_01': baseURL + 'Sermo50y_01.geojson',
    '50_02': baseURL + 'Sermo50y_02.geojson',
    '50_05': baseURL + 'Sermo50y_05.geojson',
    '100_01': baseURL + 'Sermo100y_01.geojson',
    '100_02': baseURL + 'Sermo100y_02.geojson',
    '100_05': baseURL + 'Sermo100y_05.geojson'
  },
  opak: {
    '50_01': baseURL + 'Opak50y_01.geojson',
    '50_02': baseURL + 'Opak50y_02.geojson',
    '50_05': baseURL + 'Opak50y_05.geojson',
    '100_01': baseURL + 'Opak100y_01.geojson',
    '100_02': baseURL + 'Opak100y_02.geojson',
    '100_05': baseURL + 'Opak100y_05.geojson'
  }
};

map.on('load', () => {

  map.addSource('batasKP', { type: 'geojson', data: sources.batasKP });
  map.addLayer({
    id: 'batasKP-layer', type: 'line', source: 'batasKP',
    paint: { 'line-color': '#000', 'line-width': 2 },
    layout: { visibility: 'none' }
  });

  map.addSource('fasum', { type: 'geojson', data: sources.fasum });
  map.addLayer({
    id: 'fasum-layer', type: 'fill', source: 'fasum',
    paint: { 'fill-color': '#00BFFF', 'fill-opacity': 0.5 },
    layout: { visibility: 'none' }
  });

  map.on('click', 'fasum-layer', (e) => {
    const nama = e.features[0].properties.NAMA;
    const img = fasumImages[nama];

    let html = `<b>${nama}</b><br>`;
    html += img ? `<img src="${img}" width="250" style="margin-top:6px;border-radius:10px;">`
                : `<i>(Gambar tidak tersedia)</i>`;

    new mapboxgl.Popup().setLngLat(e.lngLat).setHTML(html).addTo(map);
  });

  map.on('mouseenter', 'fasum-layer', () => map.getCanvas().style.cursor = 'pointer');
  map.on('mouseleave', 'fasum-layer', () => map.getCanvas().style.cursor = '');

  // FIXED updateLayers
  function updateLayers(prefix) {
    Object.keys(sources[prefix]).forEach(key => {
      const id = `${prefix}_${key}`;
      if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', 'none');
    });

    const periods = document.querySelectorAll(`.${prefix}-period:checked`);
    const probs = document.querySelectorAll(`.${prefix}-prob:checked`);

    periods.forEach(p => {
      probs.forEach(pr => {
        const id = `${prefix}_${p.dataset.period}_${pr.dataset.prob}`;
        if (map.getLayer(id)) map.setLayoutProperty(id, 'visibility', 'visible');
      });
    });
  }

});
</script>

</body>
</html>
